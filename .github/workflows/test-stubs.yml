name: Test Code Stubs

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  test-project-01:
    name: Test Project 01 Stubs
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx

    - name: Test API stubs (Project 01)
      working-directory: projects/project-01-basic-model-serving
      run: |
        # Verify imports work
        python -c "from src.api import app; print('API imports OK')"
        python -c "from src.model import ModelManager; print('Model imports OK')"
        python -c "from src.utils import setup_logging; print('Utils imports OK')"

    - name: Run stub tests
      working-directory: projects/project-01-basic-model-serving
      run: |
        pytest tests/ -v --tb=short || true

  validate-docker:
    name: Validate Dockerfiles
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate Project 01 Dockerfile
      working-directory: projects/project-01-basic-model-serving
      run: |
        docker buildx build --platform linux/amd64 -t test-project-01 . --load || echo "Docker build failed (expected for stub)"

    - name: Run hadolint (Dockerfile linter)
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: projects/project-01-basic-model-serving/Dockerfile
        failure-threshold: warning

  validate-kubernetes:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    - name: Validate K8s manifests (Project 01)
      working-directory: projects/project-01-basic-model-serving/kubernetes
      run: |
        kubectl apply --dry-run=client -f deployment.yaml
        kubectl apply --dry-run=client -f service.yaml
        kubectl apply --dry-run=client -f configmap.yaml
        kubectl apply --dry-run=client -f hpa.yaml

    - name: Lint K8s manifests with kubeval
      run: |
        wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar xf kubeval-linux-amd64.tar.gz
        sudo mv kubeval /usr/local/bin
        find projects/project-01-basic-model-serving/kubernetes -name '*.yaml' -exec kubeval {} \; || true

  validate-lesson-code:
    name: Validate Lesson Code Examples
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Extract and validate Python code blocks
      run: |
        # This script extracts Python code blocks from markdown and validates syntax
        python << 'EOF'
        import re
        import sys
        from pathlib import Path

        errors = []
        lesson_files = list(Path("lessons").rglob("*.md"))

        for lesson_file in lesson_files:
            content = lesson_file.read_text()
            # Find all Python code blocks
            code_blocks = re.findall(r'```python\n(.*?)\n```', content, re.DOTALL)

            for i, code in enumerate(code_blocks):
                try:
                    compile(code, f"{lesson_file}:block_{i}", "exec")
                except SyntaxError as e:
                    errors.append(f"{lesson_file}:block_{i} - {e}")

        if errors:
            print("Syntax errors found in lesson code blocks:")
            for error in errors:
                print(f"  - {error}")
            sys.exit(1)
        else:
            print(f"All {len(lesson_files)} lesson files validated successfully!")
        EOF

  check-todos:
    name: Check for Incomplete TODOs
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Count TODOs in code
      run: |
        echo "=== TODO Summary ==="
        find projects -name "*.py" -exec grep -l "# TODO" {} \; | wc -l | xargs echo "Files with TODOs:"
        find projects -name "*.py" -exec grep -c "# TODO" {} \; | awk '{sum += $1} END {print "Total TODOs: " sum}'
        echo ""
        echo "=== TODO Details ==="
        find projects -name "*.py" -exec grep -n "# TODO" {} \;

  validate-env-files:
    name: Validate Environment Files
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check .env.example files
      run: |
        # Ensure .env.example exists for each project
        for project in projects/*/; do
          if [ -f "$project/.env.example" ]; then
            echo "✓ Found .env.example in $project"
          else
            echo "✗ Missing .env.example in $project"
          fi
        done

    - name: Validate .env.example format
      run: |
        # Check that .env.example files have valid format
        find projects -name ".env.example" -exec sh -c '
          echo "Checking: $1"
          while IFS= read -r line; do
            if [ -n "$line" ] && ! echo "$line" | grep -qE "^(#|[A-Z_]+=(.*))$"; then
              echo "Invalid line in $1: $line"
              exit 1
            fi
          done < "$1"
        ' sh {} \;

  comprehensive-report:
    name: Generate Validation Report
    runs-on: ubuntu-latest
    needs: [validate-python, validate-markdown, validate-yaml, test-project-01, validate-docker, validate-kubernetes]
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Generate report
      run: |
        echo "# Validation Report" > report.md
        echo "" >> report.md
        echo "**Date**: $(date)" >> report.md
        echo "**Branch**: ${{ github.ref }}" >> report.md
        echo "" >> report.md
        echo "## Results" >> report.md
        echo "" >> report.md
        echo "- Python validation: ${{ needs.validate-python.result }}" >> report.md
        echo "- Markdown validation: ${{ needs.validate-markdown.result }}" >> report.md
        echo "- YAML validation: ${{ needs.validate-yaml.result }}" >> report.md
        echo "- Project 01 tests: ${{ needs.test-project-01.result }}" >> report.md
        echo "- Docker validation: ${{ needs.validate-docker.result }}" >> report.md
        echo "- Kubernetes validation: ${{ needs.validate-kubernetes.result }}" >> report.md

        cat report.md

    - name: Upload report
      uses: actions/upload-artifact@v3
      with:
        name: validation-report
        path: report.md
